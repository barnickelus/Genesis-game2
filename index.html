<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Genesis Evolution â€” Star-Frenzy (Math-Dragon v1.1-fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
 html,body{margin:0;height:100%;background:#060616;overflow:hidden;font-family:Inter,Arial,sans-serif}
 canvas{width:100%;height:100%;display:block;touch-action:none;background:#000}
 #hud{position:fixed;top:14px;left:18px;color:#fff;font-size:15px;text-shadow:0 0 4px #0008;z-index:2}
 #zoomSlider{position:fixed;top:130px;right:18px;width:70px;transform:rotate(-90deg);z-index:2}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud">Mass <span id="mass">10</span>  Score <span id="score">0</span>  lvl <span id="lvl">1</span></div>
<input id="zoomSlider" type="range" min="0.5" max="2" step="0.01" value="1">

<script>
/* ========= CONSTANTS & HELPERS ========= */
const TWO = Math.PI * 2;
const RAND = v => Math.random() * v - v / 2;
const dist = (ax, ay, bx, by) => Math.hypot(ax - bx, ay - by);
const lerp = (a, b, t) => a + (b - a) * t;
const hsv  = (h, s, l) => `hsl(${h} ${s}% ${l}%)`;

/* mass-decay (25 % slower than original) */
const DECAY_SURF = 0.000006;
const DECAY_CONST_SMALL = 0.0015;
const DECAY_CONST_BIG   = 0.00225;

/* gameplay */
const FOOD_MAX = 80, FOE_MAX = 18, FRENZY_MS = 6000;
const FOE_MAX_SPEED = 3.2, FOE_FRICTION = 0.985;

/* ========= CANVAS ========= */
const cv = document.getElementById('game');
const ctx = cv.getContext('2d', { alpha: false });
let W, H;
function resize(){ W = cv.width = innerWidth; H = cv.height = innerHeight; }
resize();  onresize = resize;

let zoom = 1, sliderZoom = 1;
document.getElementById('zoomSlider').oninput = e => sliderZoom = +e.target.value;

/* ========= HUD refs ========= */
const massEl  = document.getElementById('mass');
const scoreEl = document.getElementById('score');
const lvlEl   = document.getElementById('lvl');

/* ========= WORLD STATE ========= */
const player = { x:0, y:0, mass:10, r:15, tail:[], blink:0, frenzy:0 };
let   target = { x:0, y:0, active:false };
let   offset = { x:0, y:0 };
const food = [], foes = [];
let   score = 0, last = 0;

/* ========= STARFIELD ========= */
const stars = Array.from({length:120}, () => ({
  x: RAND(2000),
  y: RAND(2000),
  s: Math.random()*1.2 + 0.4
}));

/* ========= INPUT ========= */
const toWorld = e => ({ x:(e.clientX - offset.x)/zoom, y:(e.clientY - offset.y)/zoom });
cv.onpointerdown = e => { const p = toWorld(e); target = { x:p.x, y:p.y, active:true }; };
cv.onpointermove = e => { if(target.active){ const p = toWorld(e); target.x = p.x; target.y = p.y; } };
cv.onpointerup   = () => target.active = false;

/* ========= SPAWNING ========= */
function spawnFood(){ while(food.length < FOOD_MAX) food.push({ x:RAND(1800), y:RAND(1800), r:6 }); }
function spawnFoe (){
  foes.push({ x:RAND(2000), y:RAND(2000), r:10+Math.random()*22,
              vx: RAND(.8), vy: RAND(.8) });
}
while(foes.length < 12) spawnFoe();

/* ========= GLOW HELPERS ========= */
function glow(x,y,r,c,a){
  if(r*zoom < .7) return;
  ctx.globalAlpha = a;
  ctx.shadowBlur  = 12*zoom;
  ctx.shadowColor = c;
  ctx.fillStyle   = c;
  ctx.beginPath(); ctx.arc(x,y,r,0,TWO); ctx.fill();
  ctx.shadowBlur = ctx.globalAlpha = 0;
}
function floorGlow(x,y,r){
  if(r*zoom < 1) return;
  ctx.save();
  ctx.translate(x, y + r*0.6);
  ctx.scale(2.5, 0.55);
  ctx.globalAlpha = 0.28;
  const g = ctx.createRadialGradient(0,0,r*0.4,0,0,r*1.4);
  g.addColorStop(0,'rgba(0,228,184,.9)');
  g.addColorStop(1,'transparent');
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(0,0,r*1.4,0,TWO); ctx.fill();
  ctx.restore();
}

/* ========= PROCEDURAL DRAGON ========= */
function drawDragon(x,y,r,blink){
  const seg = 48, len = r*3.2;
  for(let i=0;i<seg;i++){
    const t = i/seg;
    const a = Math.sin(t*Math.PI*1.2)*0.7;
    const px = x + Math.cos(a)*len*(t-0.5);
    const py = y + Math.sin(a)*len*(t-0.5)*0.6;
    const pr = r*(1-Math.pow(t,1.8))*0.9;
    glow(px,py,pr,hsv(190+140*t,100,60),0.33);
  }
  ctx.save();
  ctx.translate(x + len*0.48, y - 0.18*r);
  ctx.rotate(-0.15);
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(r*1.0, -r*0.30);
  ctx.lineTo(r*1.1, -r*0.05);
  ctx.lineTo(r*1.0,  r*0.28);
  ctx.closePath();
  const grd = ctx.createLinearGradient(0,-r*0.4, r*1.1, r*0.4);
  grd.addColorStop(0,'#00e4b8');  grd.addColorStop(1,'#ff39ff');
  ctx.fillStyle = grd; ctx.fill();
  ctx.fillStyle = blink ? '#fff' : '#fffa8a';
  ctx.fillRect(r*0.55, -r*0.06, r*0.25, r*0.12);
  ctx.restore();
}

/* ========= FRENZY PILL ========= */
const pill = { x:RAND(1600), y:RAND(1600), r:10, active:false, cd:0 };

/* ========= MAIN LOOP ========= */
function loop(ts){
  const dt = (ts - last) || 16;  last = ts;

  /* camera zoom */
  zoom += (sliderZoom - zoom) * 0.18;
  offset.x = W/2 - player.x*zoom;
  offset.y = H/2 - player.y*zoom;

  /* movement */
  const dx = ( (target.active?target.x:player.x) - player.x );
  const dy = ( (target.active?target.y:player.y) - player.y );
  const dLen = Math.hypot(dx,dy);
  const speed = (player.frenzy?3.7:2.7) * (1 + player.mass*0.001);
  if(dLen > 1){ player.x += dx/dLen * speed; player.y += dy/dLen * speed; }

  /* mass decay + size */
  const decay = DECAY_SURF*player.r*player.r +
                (player.mass < 150 ? DECAY_CONST_SMALL : DECAY_CONST_BIG);
  player.mass = Math.max(5, player.mass - decay*dt);
  player.r    = 10 + player.mass / 15;

  if(player.frenzy > 0) player.frenzy = Math.max(0, player.frenzy - dt);
  if(player.blink  > 0) player.blink  -= dt;

  /* food */
  spawnFood();
  food.forEach((f,i)=>{
    if(dist(player.x,player.y,f.x,f.y) < player.r + f.r){
      player.mass += f.r;
      food.splice(i,1);
      score += 10 * (player.frenzy?2:1);
    }
  });

  /* foes */
  while(foes.length < FOE_MAX) spawnFoe();
  foes.forEach((o,i)=>{
    const d = dist(player.x,player.y,o.x,o.y);

    /* steer */
    if(o.r < player.r && d < 320){
      o.vx -= (player.x - o.x)/d * 0.04;
      o.vy -= (player.y - o.y)/d * 0.04;
    }
    if(o.r > player.r && d < 260){
      o.vx += (player.x - o.x)/d * 0.07;
      o.vy += (player.y - o.y)/d * 0.07;
    }

    /* wander + friction */
    o.vx += RAND(0.04); o.vy += RAND(0.04);
    o.vx *= FOE_FRICTION; o.vy *= FOE_FRICTION;

    /* cap speed */
    const sp = Math.hypot(o.vx,o.vy);
    if(sp > FOE_MAX_SPEED){ o.vx *= FOE_MAX_SPEED/sp; o.vy *= FOE_MAX_SPEED/sp; }

    o.x += o.vx; o.y += o.vy;

    /* wrap far away */
    if(Math.abs(o.x - player.x) > 2000) o.x = player.x + RAND(1800);
    if(Math.abs(o.y - player.y) > 2000) o.y = player.y + RAND(1800);

    /* collisions */
    if(player.r > o.r && d < player.r){
      player.mass += o.r*2.2; score += 75*(player.frenzy?2:1); foes.splice(i,1);
    }else if(o.r > player.r && d < o.r){
      player.mass = Math.max(5, player.mass - o.r*0.6); player.blink = 200;
    }
  });

  /* frenzy pill */
  if(!pill.active){
    pill.cd += dt;
    if(pill.cd > 25000 + Math.random()*10000){
      pill.x = RAND(1600); pill.y = RAND(1600); pill.active = true; pill.cd = 0;
    }
  }
  if(pill.active){
    const ph = (Math.sin(ts*0.006)+1)/2;
    glow(pill.x,pill.y,pill.r,hsv(200+160*ph,100,60),0.9);
    if(dist(player.x,player.y,pill.x,pill.y) < player.r + pill.r){
      pill.active = false; player.frenzy = FRENZY_MS;
    }
  }

  /* ===== RENDER ===== */
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#060616';
  ctx.fillRect(0,0,W,H);

  /* stars */
  ctx.fillStyle = '#222';
  stars.forEach(s=>{
    const sx = (s.x - player.x*0.1)*zoom + offset.x;
    const sy = (s.y - player.y*0.1)*zoom + offset.y;
    if(sx<0||sx>W||sy<0||sy>H) return;
    ctx.fillRect(sx,sy,s.s,s.s);
  });

  ctx.setTransform(zoom,0,0,zoom,offset.x,offset.y);

  food.forEach(f=>glow(f.x,f.y,f.r,'#ff0',0.65));
  foes.forEach(o=>glow(o.x,o.y,o.r,'#f00',0.85));

  /* frenzy ring */
  if(player.frenzy > 0){
    const f = player.frenzy / FRENZY_MS;
    ctx.lineWidth = 4;
    ctx.strokeStyle = `rgba(255,57,255,${f})`;
    ctx.beginPath(); ctx.arc(player.x,player.y,player.r + 40*(1-f),0,TWO); ctx.stroke();
  }

  floorGlow(player.x,player.y,player.r);

  /* tail */
  player.tail.unshift({x:player.x,y:player.y});
  while(player.tail.length > 40) player.tail.pop();
  const skip = Math.max(1,Math.ceil(player.tail.length / 50));
  for(let i=0;i<player.tail.length;i+=skip){
    const t = i/player.tail.length;
    glow(player.tail[i].x, player.tail[i].y,
         player.r*(1-t), hsv(190+140*t,100,60), 0.28);
  }

  drawDragon(player.x,player.y,player.r, player.blink>0 && (player.blink%200 < 100));

  /* HUD */
  massEl.textContent  = player.mass.toFixed(0);
  scoreEl.textContent = Math.floor(score);
  lvlEl.textContent   = Math.floor(player.mass/100) + 1;

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>