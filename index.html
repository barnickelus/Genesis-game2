<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Genesis Evolution — Star-Frenzy (mirror-fixed, full)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
 html,body{margin:0;height:100%;background:#060616;overflow:hidden;font-family:"Inter",Arial,sans-serif;}
 canvas{width:100%;height:100%;display:block;touch-action:none;background:#000;}
 #hud{position:fixed;top:14px;left:18px;color:#fff;font-size:15px;text-shadow:0 0 4px rgba(255,255,255,.3);z-index:2;}
 #compass{position:fixed;top:60px;left:18px;color:#aaa;font-size:12px;line-height:12px;letter-spacing:1px;text-shadow:0 0 2px #000;z-index:2;}
 #effBar{position:fixed;bottom:14px;left:18px;width:220px;height:18px;border-radius:9px;background:rgba(255,255,255,.12);z-index:2;}
 #effFill{width:100%;height:100%;border-radius:9px;background:#00e4b8;}
 #pauseBtn{position:fixed;top:14px;right:18px;font-size:22px;color:#fff;cursor:pointer;user-select:none;z-index:2;}
 #radarWrap{position:fixed;top:48px;right:18px;width:70px;height:70px;display:none;z-index:2;}
 #radar{width:70px;height:70px;border:1px solid #555;border-radius:4px;background:rgba(0,0,0,.4);}
 #zoomSlider{position:fixed;top:130px;right:18px;width:70px;transform:rotate(-90deg);z-index:2;}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="hud">Mass: <span id="mass">10</span>&nbsp; Score: <span id="score">0</span>&nbsp; <span id="level">1</span></div>
<div id="compass">N<br>E&nbsp;&nbsp;W<br>&nbsp;S</div>
<div id="effBar"><div id="effFill"></div></div>
<div id="pauseBtn">⏸︎</div>
<div id="radarWrap"><canvas id="radar" width="70" height="70"></canvas></div>
<input id="zoomSlider" type="range" min="0.5" max="2" step="0.01" value="1">
<audio id="backgroundMusic" src="background-music.mp3" loop preload="auto"></audio>
<audio id="eatSnd" src="eat.mp3" preload="auto"></audio>
<audio id="hurtSnd" src="hurt.mp3" preload="auto"></audio>
<audio id="frenzySnd" src="frenzy.mp3" preload="auto"></audio>

<script>
/* ================================================================
   DragonHead v3-b  |  3 silhouettes + pixel-constant neon glow
   ================================================================ */
const DragonHead = (() => {
  const BASE_DARK='#008c70',BASE_MID='#00bfa0',BASE_LITE='#00e8d0',
        HILITE='#00ffff',GLOW='#00faff',EYE_CORE='#ffe26b',EYE_GLOW='#ffffff',
        TONGUE='#ff3a80';

  /* right-facing outlines */
  const SIDE = new Path2D(`M  40 -6 Q  52 -16  34 -24 L  20 -30 Q  30 -44  12 -40
                             L   0 -46 Q  -3 -32  10 -24 L -10 -16 Q -22  -8 -20 0
                             Q -10   6  -2   8   10   6 L  22  12 Q  24  26  40 18
                             Q  60  10  54  -2 Z`);
  const DIAG = new Path2D(`M  36 -4 Q  46 -12  30 -20 L  16 -26 Q  24 -36   8 -32
                             L   0 -36 Q  -2 -24   8 -16 L  -8 -10 Q -18  -4 -14 4
                             Q  -6   8   4   6 L  16  12 Q  18  22  34 16 Q  46 10  40 0 Z`);
  const TOP  = new Path2D(`M  0 -32 Q  14 -26  26 -14 Q  32   0  26 14
                             Q  14  26   0  32 Q -14  26 -26 14
                             Q -32   0 -26 -14 Q -14 -26   0 -32 Z`);

  const paths = { side:SIDE, diag:DIAG, top:TOP };

  const glowStroke = (ctx,path,px) => {
    ctx.lineCap = ctx.lineJoin = 'round';
    ctx.lineWidth   = px;
    ctx.strokeStyle = HILITE;
    ctx.shadowBlur  = px * 4;
    ctx.shadowColor = GLOW;
    ctx.save(); ctx.globalCompositeOperation = 'lighter'; ctx.stroke(path); ctx.restore();
    ctx.shadowBlur = 0;
  };

  const variantFor = ang => {
    const oct = (Math.round(((ang%(2*Math.PI))+2*Math.PI)/(Math.PI/4))) & 7;
    return (oct & 1) ? 'diag' : ((oct === 2 || oct === 6) ? 'top' : 'side');
  };

  function draw(ctx,x,y,r,ang,blink=0){
    const v = variantFor(ang), p = paths[v];
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(ang);
    if(Math.cos(ang)<0) ctx.scale(1,-1);   /* mirror for headings pointing West */

    const s = r / 32;
    ctx.scale(s,s);

    glowStroke(ctx,p,6/s);

    /* body gradient */
    const g = ctx.createRadialGradient(0,-4,4,0,0,36);
    g.addColorStop(0,BASE_LITE); g.addColorStop(0.35,BASE_MID); g.addColorStop(1,BASE_DARK);
    ctx.fillStyle = g; ctx.fill(p);

    /* ridge highlight */
    ctx.lineWidth = 2/s; ctx.strokeStyle = HILITE;
    ctx.shadowBlur = 14/s; ctx.shadowColor = HILITE;
    ctx.stroke(p); ctx.shadowBlur = 0;

    /* eyes */
    ctx.fillStyle = blink ? EYE_GLOW : EYE_CORE;
    if(v === 'top'){
      [[10,-6],[10,6]].forEach(([ex,ey])=>{
        ctx.beginPath(); ctx.ellipse(ex,ey,3.2,2.6,0,0,Math.PI*2); ctx.fill();
      });
      if(!blink){
        ctx.fillStyle='#000';
        [[11,-6],[11,6]].forEach(([ex,ey])=>{
          ctx.beginPath(); ctx.ellipse(ex,ey,0.9,1.3,0,0,Math.PI*2); ctx.fill();
        });
      }
    } else {
      ctx.beginPath(); ctx.ellipse(18,-4,4.2,3.4,0,0,Math.PI*2); ctx.fill();
      if(!blink){
        ctx.fillStyle='#000';
        ctx.beginPath(); ctx.ellipse(19,-4,1.3,1.6,0,0,Math.PI*2); ctx.fill();
      }
    }

    /* mouth & tongue (not for top view) */
    if(v !== 'top'){
      ctx.lineWidth = 2/s; ctx.strokeStyle = blink ? EYE_GLOW : '#101010';
      ctx.beginPath(); ctx.moveTo(8,6); ctx.lineTo(28,-2); ctx.stroke();
      ctx.fillStyle = TONGUE;
      ctx.beginPath(); ctx.moveTo(28,-2); ctx.lineTo(42,6); ctx.lineTo(22,12); ctx.closePath(); ctx.fill();
    }
    ctx.restore();
  }
  return { draw };
})();

/* ================================================================
   CONSTANTS & VARIABLES
   ================================================================ */
const MASS_THRESH=600, TITAN_LEVEL=10, TITAN_MAX=6, TITAN_RESPAWN_MS=20000,
      SPECTRE_MAX=3, REAPER_MAX=3, C_RING_DIST=1600;
const SPECTRE_SPEED_MS=6000, SPECTRE_SPEED_MULT=1.25,
      RADAR_PADDING=4, ZOOM_EASE=0.25;
const MASS_SPEED_FACTOR=0.0012, EXTRA_TAIL_PCT=0.10, MAX_TAIL_DRAW=60,
      SAFE_PLAYER_MASS=70, BLINK_MS=300;

/* ================================================================
   CANVAS / VIEWPORT
   ================================================================ */
const canvas=document.getElementById("game"), ctx=canvas.getContext("2d",{alpha:false});
ctx.imageSmoothingEnabled=false;
let W,H;
function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;}
resize(); addEventListener("resize",resize);

let sliderZoom=1, zoom=1;
document.getElementById("zoomSlider").addEventListener("input",e=>sliderZoom=parseFloat(e.target.value));

/* ================================================================
   HUD REFERENCES
   ================================================================ */
const massEl=document.getElementById("mass"),
      scoreEl=document.getElementById("score"),
      levelEl=document.getElementById("level");
const pauseBtn=document.getElementById("pauseBtn"),
      radarWrap=document.getElementById("radarWrap"),
      rctx=document.getElementById("radar").getContext("2d");

/* ================================================================
   WORLD STATE
   ================================================================ */
let player={
  x:0,y:0,r:15,mass:10,tail:[],
  baseSpeed:2.5, blink:0, speedBoost:0, heading:0
};
let target={x:0,y:0,active:false}, offset={x:0,y:0};
const food=[], foes=[], titans=[], spectres=[], reapers=[], beacons=[];
let pill={x:0,y:0,r:10,active:false,cd:0};
let frenzy=false, F_TIME=0;
let paused=false, radarActive=false;
let titanTimer=0, titanKill=0, spectreKill=0, level=1;

/* starfield */
const STARS=120, stars=[...Array(STARS)].map(()=>({x:Math.random()*4000-2000,y:Math.random()*4000-2000,s:Math.random()*1.5+0.5}));

/* ================================================================
   UTILITY FUNCTIONS
   ================================================================ */
const rand=v=>Math.random()*v-v/2;
const dist=(a,b,c,d)=>Math.hypot(a-c,b-d);
const onScreen=(x,y,r)=>!(x+r<player.x-W/(2*zoom)||x-r>player.x+W/(2*zoom)||y+r<player.y-H/(2*zoom)||y-r>player.y+H/(2*zoom));
const lerp=(a,b,t)=>a+(b-a)*t;
const rgb=h=>({r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16)});
const mix=(a,b,t)=>{const A=rgb(a),B=rgb(b);return`rgb(${Math.round(lerp(A.r,B.r,t))},${Math.round(lerp(A.g,B.g,t))},${Math.round(lerp(A.b,B.b,t))})`;};

/* ================================================================
   PARTICLES
   ================================================================ */
const particles=[];
function spawnBurst(x,y,c){for(let i=0;i<12;i++)particles.push({x,y,dx:rand(2),dy:rand(2),r:3,ttl:600,col:c});}

/* ================================================================
   SPAWNERS
   ================================================================ */
function spawnFood(){while(food.length<60)food.push({x:rand(1800),y:rand(1800),r:6});}
function spawnFoe(){foes.push({x:rand(2000),y:rand(2000),r:(player.mass>=MASS_THRESH?14:10)+Math.random()*20});}
function spawnTitan(){const a=Math.random()*Math.PI*2,d=700+Math.random()*500;titans.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:25+Math.random()*35,hop:0});}
function spawnSpectre(){const a=Math.random()*Math.PI*2,d=600+Math.random()*400;spectres.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:22+Math.random()*25,dash:0});}
function spawnReaper(){const a=Math.random()*Math.PI*2,d=800+Math.random()*600;reapers.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:38+Math.random()*28,charge:0});}
function spawnPill(){pill={x:rand(1800),y:rand(1800),r:10,active:true,cd:0};}

/* initial world content */
spawnFood(); for(let i=0;i<12;i++)spawnFoe();
["N","S","E","W"].forEach(d=>{
  const p={N:[0,-C_RING_DIST],S:[0,C_RING_DIST],E:[C_RING_DIST,0],W:[-C_RING_DIST,0]}[d];
  beacons.push({x:p[0],y:p[1],r:18});
});

/* ================================================================
   INPUT HANDLING
   ================================================================ */
const toWorld=e=>({x:(e.clientX-offset.x)/zoom,y:(e.clientY-offset.y)/zoom});
canvas.addEventListener("pointerdown",e=>{
  if(paused) return;
  const p=toWorld(e); target.x=p.x; target.y=p.y; target.active=true;
});
canvas.addEventListener("pointermove",e=>{
  if(!target.active || paused) return;
  const p=toWorld(e); target.x=p.x; target.y=p.y;
});
canvas.addEventListener("pointerup",()=>target.active=false);

/* ================================================================
   PAUSE TOGGLE
   ================================================================ */
pauseBtn.onclick=()=>{
  paused=!paused;
  pauseBtn.textContent=paused?"▶︎":"⏸︎";
  const bg=document.getElementById("backgroundMusic");
  if(bg) paused ? bg.pause() : bg.play().catch(()=>{});
};

/* ================================================================
   DRAW HELPERS
   ================================================================ */
function glow(x,y,r,c,a){
  if(r*zoom<0.8 || !onScreen(x,y,r)) return;
  ctx.globalAlpha=a; ctx.shadowBlur=12*zoom; ctx.shadowColor=c;
  ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0; ctx.globalAlpha=1;
}
function drawGrid(){
  const step=(zoom<=0.8?60:120),depth=6;
  ctx.lineWidth=1.2;
  for(let z=0; z<depth; z++){
    const scale=1+z*0.15,opa=0.8-0.12*z;
    ctx.strokeStyle=`rgba(34,34,34,${opa})`;
    for(let i=-4;i<=4;i++)for(let j=-4;j<=4;j++){
      const x=i*step*scale,y=j*step*scale;
      if(!onScreen(x,y,step*scale*1.4)) continue;
      drawCube(x,y,step*scale);
    }
  }
  function drawCube(x,y,s){
    ctx.beginPath(); ctx.rect(x,y,s,s); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x-s*0.4,y-s*0.4); ctx.lineTo(x-s*0.4+s,y-s*0.4); ctx.lineTo(x+s,y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x+s,y); ctx.lineTo(x+s+s*0.4,y-s*0.4); ctx.lineTo(x+s+s*0.4-s,y-s*0.4+s); ctx.lineTo(x+s,y+s); ctx.stroke();
  }
}

/* ================================================================
   GAME LOOP
   ================================================================ */
let last=0;
function loop(ts){
  if(paused){ last=ts; return requestAnimationFrame(loop); }
  const dt=(ts-last)||16; last=ts;

  /* smooth zoom */
  zoom = lerp(zoom, Math.min(sliderZoom, Math.max(0.5, H/(player.r*4))), ZOOM_EASE);

  /* movement & mass decay */
  const dx=(target.active?target.x:player.x)-player.x,
        dy=(target.active?target.y:player.y)-player.y,
        dLen=Math.hypot(dx,dy);
  if(dLen>0.5) player.heading=Math.atan2(dy,dx);

  if(player.speedBoost>0) player.speedBoost=Math.max(0,player.speedBoost-dt);
  const speed=player.baseSpeed*(player.speedBoost>0?SPECTRE_SPEED_MULT:1)*(frenzy?1.3:1)*(1+player.mass*MASS_SPEED_FACTOR);
  if(dLen>1){ player.x+=dx/dLen*speed; player.y+=dy/dLen*speed; }

  player.mass=Math.max(5,
    player.mass - (0.000009*player.r*player.r + (player.mass<150?0.002:0.003))*dt);

  /* camera offset */
  offset.x=W/2-player.x*zoom;
  offset.y=H/2-player.y*zoom;

  /* ================= BACKGROUND ================= */
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#060616"; ctx.fillRect(0,0,W,H);
  ctx.fillStyle="#222";
  for(const s of stars){
    const sx=(s.x-player.x*0.1)*zoom+offset.x,
          sy=(s.y-player.y*0.1)*zoom+offset.y;
    if(sx<0||sx>W||sy<0||sy>H) continue;
    ctx.fillRect(sx,sy,s.s,s.s);
  }

  /* ================= WORLD SPACE ================= */
  ctx.setTransform(zoom,0,0,zoom,offset.x,offset.y);
  drawGrid();

  /* ---------- FOOD HANDLING ---------- */
  for(let i=food.length-1;i>=0;i--){
    const f=food[i];
    if(dist(player.x,player.y,f.x,f.y)<player.r+f.r){
      player.mass+=f.r; food.splice(i,1);
      spawnBurst(f.x,f.y,"#ff0");
      document.getElementById('eatSnd').play().catch(()=>{});
    }
  }
  spawnFood();

  /* ---------- FOES AI ---------- */
  while(foes.length<(player.mass>=MASS_THRESH?18:12)) spawnFoe();
  foes.forEach((o,i)=>{
    const d=dist(player.x,player.y,o.x,o.y);
    if(player.r>o.r && d<player.r){
      player.mass+=o.r*2.5; foes.splice(i,1);
      spawnBurst(o.x,o.y,"#f00");
      document.getElementById('eatSnd').play().catch(()=>{});
      return;
    }
    if(o.r>player.r && d<o.r){
      if(player.blink<50) player.blink=BLINK_MS;
      player.mass=Math.max(5,player.mass-0.04*dt);
      document.getElementById('hurtSnd').play().catch(()=>{});
    }
    const c=1;
    if(o.r<player.r && d<250){ o.x-=(player.x-o.x)/d*c; o.y-=(player.y-o.y)/d*c; }
    else if(o.r>player.r && d<250){ o.x+=(player.x-o.x)/d*c; o.y+=(player.y-o.y)/d*c; }
  });

  /* ---------- TITANS ---------- */
  if(level>=TITAN_LEVEL){
    while(titans.length<TITAN_MAX) spawnTitan();
    titanTimer+=dt;
    if(titanTimer>TITAN_RESPAWN_MS){ titanTimer=0; titans.length=0; }
  }
  titans.forEach((o,i)=>{
    const d=dist(player.x,player.y,o.x,o.y);
    if(d>2000){ titans.splice(i,1); spawnTitan(); return; }
    if(player.r>o.r && d<player.r){
      player.mass+=o.r*5; titans.splice(i,1); titanKill++;
      spawnBurst(o.x,o.y,"#cc00ff"); return;
    }
    if(o.r>player.r && d<o.r){
      if(player.blink<50) player.blink=BLINK_MS;
      player.mass=Math.max(5,player.mass-0.1*dt);
      document.getElementById('hurtSnd').play().catch(()=>{});
    }
    o.hop-=dt;
    if(o.hop<=0){
      o.hop=700;
      const hop=o.r>player.r?120:-80;
      o.x+=(player.x-o.x)/d*hop;
      o.y+=(player.y-o.y)/d*hop;
    }
  });

  /* ---------- SPECTRES ---------- */
  if(titanKill>=10) while(spectres.length<SPECTRE_MAX) spawnSpectre();
  spectres.forEach((s,i)=>{
    s.dash-=dt;
    const d=dist(player.x,player.y,s.x,s.y),
          ignore=player.mass<SAFE_PLAYER_MASS;
    if(d>2200){ spectres.splice(i,1); spawnSpectre(); return; }
    if(!ignore && d<player.r){
      player.mass+=s.r*7; player.speedBoost=SPECTRE_SPEED_MS;
      spectres.splice(i,1);
      document.getElementById('eatSnd').play().catch(()=>{});
      spectreKill++;
      if(spectreKill%6===0 && reapers.length<REAPER_MAX) spawnReaper();
      return;
    }
    if(!ignore && d<s.r && s.r>player.r){
      if(player.blink<50) player.blink=BLINK_MS;
      player.mass=Math.max(5,player.mass-0.2*dt);
      document.getElementById('hurtSnd').play().catch(()=>{});
    }
    const jump=ignore?-100:(s.r>player.r?160:-100);
    if(s.dash<=0){
      s.dash=400;
      s.x+=(player.x-s.x)/d*jump;
      s.y+=(player.y-s.y)/d*jump;
    }
  });

  /* ---------- REAPERS ---------- */
  reapers.forEach((r,i)=>{
    r.charge-=dt;
    const d=dist(player.x,player.y,r.x,r.y),
          ignore=player.mass<SAFE_PLAYER_MASS;
    if(d>2400){ reapers.splice(i,1); return; }
    if(!ignore && d<player.r){
      player.mass+=r.r*10; reapers.splice(i,1);
      spawnBurst(r.x,r.y,"#ff8800"); return;
    }
    if(!ignore && d<r.r && r.r>player.r){
      if(player.blink<50) player.blink=BLINK_MS;
      player.mass=Math.max(5,player.mass-0.25*dt);
      document.getElementById('hurtSnd').play().catch(()=>{});
    }
    const step=ignore?-100:(r.r>player.r?130:-100);
    if(r.charge<=0){
      r.charge=300;
      r.x+=(player.x-r.x)/d*step;
      r.y+=(player.y-r.y)/d*step;
    }
  });

  /* ---------- PILL & FRENZY ---------- */
  if(pill.active && dist(player.x,player.y,pill.x,pill.y)<player.r+pill.r){
    frenzy=true; F_TIME=10000; pill.active=false;
    document.getElementById('frenzySnd').play().catch(()=>{});
    for(let i=0;i<40;i++){
      const a=Math.random()*Math.PI*2, r=120+Math.random()*120;
      food.push({
        cx:player.x, cy:player.y, ang:a, baseR:r,
        angV:0.004+Math.random()*0.003,
        x:player.x+Math.cos(a)*r, y:player.y+Math.sin(a)*r,
        r:5, frenzy:true, col:"#ff39ff"
      });
    }
  }
  if(frenzy){
    F_TIME-=dt;
    if(F_TIME<=0){ frenzy=false; food.forEach(f=>f.frenzy=false); }
  }
  food.forEach(f=>{
    if(f.frenzy){
      f.ang+=f.angV*dt;
      f.x=f.cx+Math.cos(f.ang)*f.baseR;
      f.y=f.cy+Math.sin(f.ang)*f.baseR;
    }
  });

  if(!pill.active && !frenzy){
    pill.cd+=dt;
    if(pill.cd>25000+Math.random()*10000) spawnPill();
  }

  /* ---------- BEACONS ---------- */
  beacons.forEach(b=>{
    if(dist(player.x,player.y,b.x,b.y)<player.r+b.r){
      beacons.length=0; radarActive=true; radarWrap.style.display="block";
    }
  });

  /* ---------- SIZE / LEVEL / TAIL ---------- */
  player.r=10+player.mass/15;
  level=Math.floor(player.mass/100)+1;
  player.tail.unshift({x:player.x,y:player.y});
  while(player.tail.length>Math.ceil(player.mass/3*(1+EXTRA_TAIL_PCT))) player.tail.pop();
  if(player.blink>0) player.blink-=dt;

  /* ================= DRAW GLOWS ================= */
  food.forEach(f=>glow(f.x,f.y,f.r,f.frenzy?f.col:"#ff0",f.frenzy?0.8:0.65));
  foes.forEach(o=>glow(o.x,o.y,o.r,"#f00",0.8));
  titans.forEach(o=>glow(o.x,o.y,o.r,"#cc00ff",0.9));
  spectres.forEach(s=>glow(s.x,s.y,s.r,mix("#ffde59","#ff39ff",(Math.sin((ts+s.x)*0.006)+1)/2),0.9));
  reapers.forEach(r=>glow(r.x,r.y,r.r,mix("#ff8800","#ff39ff",(Math.sin((ts+r.y)*0.004)+1)/2),0.9));
  if(pill.active){
    const ph=(Math.sin(ts*0.005)+1)/2;
    glow(pill.x,pill.y,pill.r,mix("#00aaff","#ff39ff",ph),0.95);
  }

  /* tail */
  const skip=Math.max(1,Math.ceil(player.tail.length/MAX_TAIL_DRAW));
  for(let i=0;i<player.tail.length;i+=skip){
    const p=player.tail[i];
    glow(p.x,p.y,player.r*(1-i/player.tail.length),mix("#00e4b8","#ff39ff",i/player.tail.length),0.3);
  }

  /* frenzy aura */
  if(frenzy){
    ctx.globalAlpha=0.15;
    const g=ctx.createRadialGradient(player.x,player.y,player.r*0.8,player.x,player.y,player.r*8);
    g.addColorStop(0,"#ff39ff"); g.addColorStop(1,"transparent");
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(player.x,player.y,player.r*8,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }

  /* body core glow */
  glow(player.x,player.y,player.r,
       player.blink>0 ? (player.blink%200<100?"#fff":"#ff44ff") : "#00e4b8",
       1);

  /* ================= DRAGON HEAD ================= */
  DragonHead.draw(ctx,player.x,player.y,player.r*0.75,player.heading,player.blink>0?1:0);

  /* particles */
  particles.forEach((p,i)=>{
    p.x+=p.dx; p.y+=p.dy; p.ttl-=dt;
    glow(p.x,p.y,p.r,p.col,0.6);
    if(p.ttl<=0) particles.splice(i,1);
  });

  /* radar */
  if(radarActive){
    rctx.clearRect(0,0,70,70);
    rctx.strokeStyle="#666"; rctx.lineWidth=1;
    rctx.beginPath(); rctx.moveTo(35,0); rctx.lineTo(35,70);
    rctx.moveTo(0,35); rctx.lineTo(70,35); rctx.stroke();
    const mc=Math.max(C_RING_DIST,Math.abs(player.x),Math.abs(player.y))||1,
          scale=(30-RADAR_PADDING)/mc;
    const pip=(arr,col,shape)=>{
      rctx.fillStyle=col;
      arr.forEach(o=>{
        const x=35+o.x*scale, y=35+o.y*scale;
        if(x<0||x>70||y<0||y>70) return;
        if(shape==="diamond"){
          rctx.beginPath(); rctx.moveTo(x,y-2); rctx.lineTo(x+2,y); rctx.lineTo(x,y+2); rctx.lineTo(x-2,y); rctx.fill();
        } else if(shape==="triangle"){
          rctx.beginPath(); rctx.moveTo(x,y-2); rctx.lineTo(x+2,y+2); rctx.lineTo(x-2,y+2); rctx.fill();
        } else {
          rctx.fillRect(x-2,y-2,4,4);
        }
      });
    };
    pip([player],"#00e4b8","square");
    pip(titans,"#cc00ff","diamond");
    pip(spectres,"#ff39ff","triangle");
    pip(reapers,"#ff8800","square");
  }

  /* HUD values */
  massEl.textContent=player.mass.toFixed(0);
  scoreEl.textContent=Math.floor(player.mass*10);
  levelEl.textContent=level;

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ================================================================
   AUTOPLAY BACKGROUND MUSIC ON FIRST INTERACTION
   ================================================================ */
addEventListener("pointerdown",()=>{
  const bg=document.getElementById("backgroundMusic");
  if(bg && bg.paused) bg.play().catch(()=>{});
},{once:true});
</script>
</body>
</html>